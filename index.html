<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Radioactive Decay Activity Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --ok: #34d399;
      --warn: #f59e0b;
      --err: #ef4444;
      --border: #1f2a44;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --accent: #0ea5e9;
        --ok: #059669;
        --warn: #b45309;
        --err: #b91c1c;
        --border: #e2e8f0;
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans",
      "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: var(--text);
      display: grid; place-items: start center;
    }
    .wrap { width: min(960px, 95vw); margin: 24px auto; }
    h1 { font-size: clamp(1.25rem, 1.5vw + 1rem, 1.75rem); margin: 0 0 10px; }
    p.lead { color: var(--muted); margin-top: 0; }
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px;
    }
    .inputs { grid-column: span 12; }
    .outputs { grid-column: span 12; }
    @media (min-width: 900px) {
      .inputs { grid-column: span 7; }
      .outputs { grid-column: span 5; }
    }

    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .row-3 { grid-template-columns: 1fr 1fr 1fr; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 0.9rem; color: var(--muted); }
    input, select, button, textarea {
      font: inherit; background: transparent; color: var(--text);
      border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px;
    }
    input[type="number"] { -moz-appearance: textfield; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .btn {
      border: 1px solid var(--accent); color: var(--text); background: color-mix(in oklab, var(--accent) 12%, transparent);
      cursor: pointer; transition: transform .06s ease, filter .15s ease; font-weight: 600;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { border-color: var(--border); background: transparent; }

    .stat {
      border: 1px dashed var(--border); border-radius: 14px; padding: 12px;
      display: grid; gap: 6px;
    }
    .stat .label { color: var(--muted); font-size: 0.9rem; }
    .stat .value { font-size: 1.25rem; font-variant-numeric: tabular-nums lining-nums; }
    .stat.ok { border-color: color-mix(in oklab, var(--ok) 40%, var(--border)); }
    .stat.warn { border-color: color-mix(in oklab, var(--warn) 40%, var(--border)); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color: var(--muted); }
    .foot { color: var(--muted); font-size: 0.9rem; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; font-size: 0.85rem; color: var(--muted);
    }
    .notice { margin-top: 10px; font-size: 0.9rem; }
    .hr { height: 1px; background: var(--border); margin: 16px 0; }
    details summary { cursor: pointer; }
    kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; border: 1px solid var(--border); border-radius: 6px; padding: 2px 6px; background: color-mix(in oklab, var(--card) 70%, var(--bg)); }
    .ref a { color: inherit; text-decoration: underline dotted; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Radioactive Decay Activity Calculator</h1>
      <p class="lead">Enter isotope, calibration time, and reference activity. The calculator updates continuously to show the current activity.</p>
    </header>

    <div class="grid">
      <!-- Inputs -->
      <section class="card inputs">
        <div class="row">
          <div class="field">
            <label for="isotope">Isotope</label>
            <select id="isotope"></select>
          </div>
          <div class="field">
            <label for="halfLife">Half-life <span class="muted">(minutes)</span></label>
            <input id="halfLife" type="number" step="0.001" inputmode="decimal" />
            <small class="muted">Auto-filled from isotope list. You can override it.</small>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="activity0">Activity at Calibration (<span id="unitLabel">MBq</span>)</label>
            <input id="activity0" type="number" min="0" step="0.001" placeholder="e.g., 12000" inputmode="decimal" />
          </div>
          <div class="field">
            <label for="unit">Unit</label>
            <select id="unit">
              <option>MBq</option>
              <option>mCi</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="calTime">Calibration Date &amp; Time <span class="muted">(local)</span></label>
            <input id="calTime" type="datetime-local" />
          </div>
          <div class="field">
            <label for="nowTime">Current Time <span class="muted">(auto)</span></label>
            <input id="nowTime" type="datetime-local" disabled />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <button class="btn" id="recalc">Recalculate</button>
          </div>
          <div class="field">
            <button class="btn secondary" id="shareLink">Copy Shareable Link</button>
          </div>
        </div>

        <div class="notice muted">
          URL parameters supported: <span class="mono">iso</span>, <span class="mono">a0</span>, <span class="mono">unit</span>, <span class="mono">cal</span> (e.g., <span class="mono">?iso=F-18&a0=12000&unit=MBq&cal=2025-11-08T09:45</span>).
          Perfect for QR codes.
        </div>
      </section>

      <!-- Outputs -->
      <section class="card outputs">
        <div class="chips" id="statusChips"></div>

        <div class="stat" id="activityNowBox">
          <div class="label">Current Activity</div>
          <div class="value" id="activityNow">—</div>
          <div class="muted" id="activityNowAlt">—</div>
        </div>

        <div class="row">
          <div class="stat">
            <div class="label">Elapsed Time</div>
            <div class="value" id="elapsed">—</div>
            <div class="muted" id="elapsedExact">—</div>
          </div>
          <div class="stat">
            <div class="label">Decay Factor</div>
            <div class="value" id="decayFactor">—</div>
            <div class="muted">A = A₀ · e<sup>−λt</sup>, λ = ln(2)/T<sub>½</sub></div>
          </div>
        </div>

        <div class="hr"></div>

        <details class="foot">
          <summary>References</summary>
          <ul class="ref">
            <li>Exponential decay law and decay constant relationship explained by NIST. <a href="https://physics.nist.gov/cgi-bin/cuu/Info/half_life.html" target="_blank" rel="noopener">NIST: Half-life & decay constant</a></li>
            <li>Half-life data (authoritative nuclear structure & decay) available via IAEA LiveChart. <a href="https://www-nds.iaea.org/relnsd/vcharthtml/VChartHTML.html" target="_blank" rel="noopener">IAEA LiveChart</a></li>
          </ul>
        </details>
      </section>
    </div>
  </div>

  <script>
    // ---------- Half-life dataset (minutes) ----------
    // Values chosen from widely used references; verify against IAEA LiveChart for your QA release.
    // You can add more isotopes as needed.
    const HALF_LIVES_MIN = {
      "F-18": 109.771,
      "Tc-99m": 360.0,            // 6.0 h
      "I-131": 192.5 * 60,        // ~8.02 d
      "Ga-68": 67.71,
      "Lu-177": 6.647 * 24 * 60,  // 6.647 d
      "Y-90": 64.1 * 60,          // 64.1 h
      "C-11": 20.334,
      "N-13": 9.97,
      "O-15": 2.036,
      "Zr-89": 78.41 * 60,        // 78.41 h
      "Cu-64": 12.701 * 60        // 12.701 h
    };

    const qs = new URLSearchParams(location.search);

    const el = (id) => document.getElementById(id);
    const isotope = el("isotope");
    const halfLife = el("halfLife");
    const activity0 = el("activity0");
    const unit = el("unit");
    const unitLabel = el("unitLabel");
    const calTime = el("calTime");
    const nowTime = el("nowTime");
    const recalcBtn = el("recalc");
    const shareBtn = el("shareLink");

    const statusChips = el("statusChips");
    const activityNow = el("activityNow");
    const activityNowAlt = el("activityNowAlt");
    const activityNowBox = el("activityNowBox");
    const elapsed = el("elapsed");
    const elapsedExact = el("elapsedExact");
    const decayFactor = el("decayFactor");

    const MBQ_PER_MCI = 37.0;

    // Populate isotope list
    function populateIsotopes() {
      isotope.innerHTML = "";
      const keys = Object.keys(HALF_LIVES_MIN).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
      for (const key of keys) {
        const opt = document.createElement("option");
        opt.value = key; opt.textContent = key;
        isotope.appendChild(opt);
      }
      // Add a "Custom…" option to allow arbitrary isotopes with manual T1/2
      const custom = document.createElement("option");
      custom.value = "__custom__";
      custom.textContent = "Custom…";
      isotope.appendChild(custom);
    }

    function setDefaults() {
      // Default isotope
      const isoParam = qs.get("iso") || "F-18";
if (HALF_LIVES_MIN[isoParam]) {
    isotope.value = isoParam;
    halfLife.value = HALF_LIVES_MIN[isoParam];
} else {
    isotope.value = "__custom__";
    if (qs.has("t12min")) halfLife.value = qs.get("t12min");
}


      // Activity
      if (qs.has("a0")) activity0.value = qs.get("a0");
      if (qs.has("unit")) unit.value = (qs.get("unit") === "mCi") ? "mCi" : "MBq";
      unitLabel.textContent = unit.value;

      // Calibration time
      const now = new Date();
      const defaultCal = new Date(now.getTime() - 60 * 60 * 1000); // 1h ago
      const calStr = qs.get("cal") || defaultCal.toISOString().slice(0,16);
      calTime.value = normalizeToLocal(calStr);
    }

function normalizeToLocal(v) {
  const d = (v instanceof Date) ? v : new Date(v);
  if (Number.isNaN(+d)) return "";
  const pad=(n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}


    function chip(text) {
      const span = document.createElement("span");
      span.className = "chip"; span.textContent = text;
      return span;
    }

    function fmt(num, digits=3) {
      if (!isFinite(num)) return "—";
      if (num === 0) return "0";
      const abs = Math.abs(num);
      if (abs >= 1e6 || abs < 1e-3) return num.toExponential(digits);
      return num.toLocaleString(undefined, { maximumFractionDigits: digits });
    }

    function parseLocalDatetime(dtLocalValue) {
      // Treat input value (YYYY-MM-DDTHH:MM) as local time
      if (!dtLocalValue) return null;
      const [date, time] = dtLocalValue.split("T");
      if (!date || !time) return null;
      const [y,m,d] = date.split("-").map(Number);
      const [hh,mm] = time.split(":").map(Number);
      return new Date(y, (m-1), d, hh, mm, 0, 0);
    }

    function minutesBetween(a, b) {
      // b - a in minutes
      return (b.getTime() - a.getTime()) / 60000;
    }

    function decay(a0, tMin, t12min) {
      // A = A0 * exp(-ln2 * t / T1/2)
      const ln2 = Math.log(2);
      return a0 * Math.exp(-ln2 * (tMin / t12min));
    }

    function updateUnitLabel() {
      unitLabel.textContent = unit.value;
    }

    function currentParams() {
      const iso = isotope.value === "__custom__" ? (qs.get("iso") || "Custom") : isotope.value;
      const t12 = parseFloat(halfLife.value);
      const a0 = parseFloat(activity0.value);
      const un = unit.value;
      const cal = parseLocalDatetime(calTime.value);
      return { iso, t12, a0, un, cal };
    }

    function convertToMBq(value, fromUnit) {
      return (fromUnit === "mCi") ? value * MBQ_PER_MCI : value;
    }
    function convertFromMBq(valueMBq, toUnit) {
      return (toUnit === "mCi") ? (valueMBq / MBQ_PER_MCI) : valueMBq;
    }

    function classifyBox(isPreCalibration) {
      activityNowBox.classList.remove("ok","warn");
      activityNowBox.classList.add(isPreCalibration ? "warn" : "ok");
    }

    function recalcOnce() {
      // Update "now" field to device time
      const now = new Date();
      nowTime.value = normalizeToLocal(now);


      const { iso, t12, a0, un, cal } = currentParams();

      statusChips.innerHTML = "";
      if (isotope.value !== "__custom__") statusChips.appendChild(chip(`Isotope: ${iso}`));
      if (isFinite(t12)) statusChips.appendChild(chip(`T½ = ${fmt(t12,3)} min`));
      if (isFinite(a0))  statusChips.appendChild(chip(`A₀ = ${fmt(a0,3)} ${un}`));

      if (!isFinite(t12) || t12 <= 0) {
        activityNow.textContent = "Enter a valid half-life";
        activityNowAlt.textContent = "—";
        elapsed.textContent = "—";
        elapsedExact.textContent = "—";
        decayFactor.textContent = "—";
        classifyBox(false);
        return;
      }
      if (!isFinite(a0) || a0 < 0 || !cal) {
        activityNow.textContent = "Enter valid A₀ and calibration time";
        activityNowAlt.textContent = "—";
        elapsed.textContent = "—";
        elapsedExact.textContent = "—";
        decayFactor.textContent = "—";
        classifyBox(false);
        return;
      }

      const dtMin = minutesBetween(cal, now);
      const isPre = dtMin < 0; // now before calibration reference (growth towards calibration)
      const tAbs = Math.abs(dtMin);

      const a0_MBq = convertToMBq(a0, un);
      const aNow_MBq = decay(a0_MBq, dtMin, t12); // sign works: negative dt -> exponent positive (activity > A0)

      // Display
      const aDisp = convertFromMBq(aNow_MBq, un);
      const aAlt = (un === "MBq") ? (aNow_MBq / MBQ_PER_MCI) : (aNow_MBq * MBQ_PER_MCI);
      activityNow.textContent = `${fmt(aDisp, 3)} ${un}`;
      activityNowAlt.textContent = (un === "MBq")
        ? `${fmt(aAlt, 3)} mCi`
        : `${fmt(aAlt, 3)} MBq`;

      const days = Math.floor(tAbs / (60*24));
      const hours = Math.floor((tAbs - days*60*24) / 60);
      const mins = Math.floor(tAbs - days*60*24 - hours*60);

      const signWord = isPre ? "until calibration" : "since calibration";
      const parts = [];
      if (days) parts.push(`${days} d`);
      if (hours) parts.push(`${hours} h`);
      parts.push(`${mins} min`);
      elapsed.textContent = `${parts.join(" ")} ${signWord}`;
      elapsedExact.textContent = `${fmt(dtMin, 3)} minutes (signed)`;

      const lambda = Math.log(2)/t12;
      const factor = Math.exp(-lambda * dtMin);
      decayFactor.textContent = `× ${fmt(factor, 6)}`;

      classifyBox(isPre);
    }

function toLocalISOWithOffset(date) {
  const tzo = -date.getTimezoneOffset();
  const dif = tzo >= 0 ? "+" : "-";
  const pad = (num) => String(Math.floor(Math.abs(num))).padStart(2, "0");
  return date.getFullYear() +
    "-" + pad(date.getMonth() + 1) +
    "-" + pad(date.getDate()) +
    "T" + pad(date.getHours()) +
    ":" + pad(date.getMinutes()) +
    ":" + pad(date.getSeconds()) +
    dif + pad(tzo/60) +
    ":" + pad(tzo%60);
}


    function attachHandlers() {
      isotope.addEventListener("change", () => {
        if (isotope.value === "__custom__") {
          // keep user-entered half-life
        } else {
          halfLife.value = HALF_LIVES_MIN[isotope.value];
        }
        recalcOnce();
      });
      halfLife.addEventListener("input", recalcOnce);
      activity0.addEventListener("input", recalcOnce);
      unit.addEventListener("change", () => { updateUnitLabel(); recalcOnce(); });
      calTime.addEventListener("change", recalcOnce);
      recalcBtn.addEventListener("click", recalcOnce);

shareBtn.addEventListener("click", async () => {
  const { iso, t12, a0, un, cal } = currentParams();
  const params = new URLSearchParams();

  params.set("iso", iso);
  if (isotope.value === "__custom__" && isFinite(t12)) {
    params.set("t12min", String(t12));
  }

  if (isFinite(a0)) params.set("a0", String(a0));
  params.set("unit", un);

  if (cal) params.set("cal", toLocalISOWithOffset(cal));




  const url = `${location.origin}${location.pathname}?${params.toString()}`;

  try {
    await navigator.clipboard.writeText(url);
    shareBtn.textContent = "Link Copied ✓";
    setTimeout(()=> shareBtn.textContent="Copy Shareable Link", 1400);
  } catch {
    prompt("Copy this link:", url);
  }
});



      // Live update every 1s
      setInterval(recalcOnce, 1000);
    }

    // Boot
    populateIsotopes();
    setDefaults();
    attachHandlers();
    recalcOnce();
  </script>
</body>
</html>
