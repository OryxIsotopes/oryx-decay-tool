<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Oryx Isotopes Radiopharmaceuticals Activity Decay Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <style>
        :root {
            --bg: #0b1220;
            --card: #0f172a;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #22d3ee;
            --ok: #34d399;
            --warn: #f59e0b;
            --err: #ef4444;
            --border: #1f2a44;
        }

        @media (prefers-color-scheme:light) {
            :root {
                --bg: #f8fafc;
                --card: #fff;
                --text: #0f172a;
                --muted: #475569;
                --accent: #0ea5e9;
                --ok: #059669;
                --warn: #b45309;
                --err: #b91c1c;
                --border: #e2e8f0;
            }
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
            background: var(--bg);
            color: var(--text);
            display: grid;
            place-items: start center;
        }

        .wrap {
            width: min(760px,94vw);
            margin: 14px auto;
        }

        h1 {
            font-size: clamp(1.25rem,1.5vw + 1rem,1.75rem);
            margin: 0 0 10px;
        }

        p.lead {
            color: var(--muted);
            margin-top: 0;
        }

        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(12,1fr);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
        }

        .inputs, .outputs, .info, .dose {
            grid-column: span 12;
        }

        @media(min-width:900px) {
            .inputs {
                grid-column: span 7;
            }

            .outputs {
                grid-column: span 5;
            }
        }

        /* universal mobile adjustments */
        @media(max-width:600px) {
            .wrap {
                width: 100vw;
                margin: 0;
                padding: 0 6px;
            }

            body {
                overflow-x: hidden;
            }

            /* all inputs & pickers & textareas */
            input, select, textarea {
                padding: 6px 6px !important;
                font-size: 0.85rem !important;
            }

            /* specific patient column lock */
            #patientsBody input[type="time"],
            #patientsBody input[type="number"] {
                width: 85px;
                font-size: 0.80rem;
            }

            button.btn {
                padding: 8px 10px !important;
                font-size: 0.85rem !important;
            }

            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #patientsBody td {
                font-size: 0.80rem;
                padding: 2px 4px;
            }

            #patientsBody span.muted, #patientsBody .chip {
                font-size: 0.70rem;
            }

            th {
                font-size: 0.75rem;
            }
        }

        .logo-link {
            display: inline-block;
            text-decoration: none;
        }

        .logo {
            width: clamp(140px, 30vw, 260px);
            height: auto;
            margin-bottom: 12px;
            opacity: 0;
            transform: scale(0.98);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.25));
            transition: opacity 1.5s ease, transform 1.5s ease, filter 0.3s ease;
        }

        .fade-in {
            animation: logoFadeIn 1.6s ease forwards;
        }

        @keyframes logoFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
                filter: blur(3px);
            }

            to {
                opacity: 1;
                transform: scale(1);
                filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
            }
        }

        .logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.35));
        }

        @media (prefers-color-scheme: dark) {
            .logo {
                filter: drop-shadow(0 2px 4px rgba(255,255,255,0.1)) drop-shadow(0 0 6px rgba(255,255,255,0.05));
            }
        }


        /* layout utilities */
        .row {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }

        .column {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(5,1fr);
        }

        .column-2 {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
        }

        .column-3 {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(3,1fr);
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 0.9rem;
            color: var(--muted);
        }

        input, select, button, textarea {
            font: inherit;
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
        }

            input[type="number"] {
                -moz-appearance: textfield;
            }

            input::-webkit-inner-spin-button, input::-webkit-outer-spin-button {
                display: none;
            }

        .btn {
            border: 1px solid var(--accent);
            color: var(--text);
            background: color-mix(in oklab,var(--accent) 12%,transparent);
            cursor: pointer;
            transition: .06s transform,.15s filter;
            font-weight: 600;
        }

            .btn:hover {
                filter: brightness(1.05);
            }

            .btn:active {
                transform: translateY(1px);
            }

            .btn.secondary {
                border-color: var(--border);
                background: transparent;
            }

        .stat {
            border: 1px dashed var(--border);
            border-radius: 14px;
            padding: 12px;
            display: grid;
            gap: 6px;
        }

            .stat .label {
                color: var(--muted);
                font-size: 0.9rem;
            }

            .stat .value {
                font-size: 1.25rem;
                font-variant-numeric: tabular-nums lining-nums;
            }

            .stat.ok {
                border-color: color-mix(in oklab,var(--ok) 40%,var(--border));
            }

            .stat.warn {
                border-color: color-mix(in oklab,var(--warn) 40%,var(--border));
            }

        .mono {
            font-family: ui-monospace,Menlo,Consolas,monospace;
        }

        .muted {
            color: var(--muted);
        }

        .hr {
            height: 1px;
            background: var(--border);
            margin: 16px 0;
        }

        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 0.85rem;
            color: var(--muted);
        }
    </style>
</head>
<body>
    <div id="expiredOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:var(--bg);
  color:var(--err);
  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  flex-direction:column;
  padding:20px;
">
        <a href="https://www.oryxisotopes.com" target="_blank" rel="noopener" class="logo-link">
            <img src="ORYX-LOGO-FINAL-CUT-ai.png"
                 alt="Oryx Isotopes Logo"
                 class="logo fade-in" />
        </a>
        <h1 style="font-size:2rem; color:var(--err);">‚ö†Ô∏è This batch has expired</h1>
        <p style="color:var(--muted); font-size:1.1rem; max-width:480px;">
            The product is past its expiry time.<br>
            Please discard it safely or contact the Oryx Isotopes production facility.
        </p>
    </div>

    <div class="wrap">
        <header style="text-align:center;">
            <a href="https://www.oryxisotopes.com" target="_blank" rel="noopener" class="logo-link">
                <img src="ORYX-LOGO-FINAL-CUT-ai.png"
                     alt="Oryx Isotopes Logo"
                     class="logo fade-in" />
            </a>
            <h1>Oryx Isotopes Radiopharmaceuticals Activity Decay Calculator</h1>
            <p class="lead">
                Enter isotope, calibration time, and reference activity.<br />
                The calculator updates continuously to show the current activity.
            </p>
        </header>


        <div class="grid">

            <!-- Info -->
            <section class="card info">
                <h1 id="batchLabel">Shipment / Batch Info</h1>

                <div class="column">

                    <div class="field">
                        <label>Customer</label>
                        <div id="custLabel" class="muted"></div>
                    </div>
                    <div class="field">
                        <label>Doses</label>
                        <div id="dosesLabel" class="muted"></div>
                    </div>
                    <div class="field">
                        <label>Volume (mL)</label>
                        <div id="volLabel" class="muted"></div>
                    </div>
                    <div class="field">
                        <label>Expiry Date &amp; Time</label>
                        <div id="expLabel" class="muted"></div>
                    </div>
                    <div class="field">
                        <label>Remaining Time</label>
                        <div id="remainingLabel" class="muted"></div>
                    </div>
                </div>

            </section>

            <!-- Inputs -->
            <section class="card inputs">
                <div class="row">
                    <div class="field">
                        <label for="isotope">Isotope</label>
                        <select id="isotope"></select>
                    </div>
                    <div class="field">
                        <label for="halfLife">Half-life <span class="muted">(minutes)</span></label>
                        <input id="halfLife" type="number" step="0.001" inputmode="decimal" />
                        <small class="muted">Auto-filled from isotope list. You can override it.</small>
                    </div>
                </div>

                <div class="row">
                    <div class="field">
                        <label for="activity0">Activity at Calibration (<span id="unitLabel">MBq</span>)</label>
                        <input id="activity0" type="number" min="0" step="0.001" placeholder="e.g., 12000" inputmode="decimal" readonly="readonly" />
                    </div>
                    <div class="field">
                        <label for="unit">Unit</label>
                        <select id="unit">
                            <option>MBq</option>
                            <option>mCi</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="field">
                        <label for="calTime">Calibration Date &amp; Time <span class="muted">(local)</span></label>
                        <input id="calTime" type="datetime-local" />
                    </div>
                    <div class="field">
                        <label for="nowTime">Current Time <span class="muted">(auto)</span></label>
                        <input id="nowTime" type="datetime-local" disabled />
                    </div>
                </div>

                <div class="row">
                    <div class="field">
                        <button class="btn" id="recalc">Recalculate</button>
                    </div>
                    <div class="field">
                        <button class="btn secondary" id="shareLink">Copy Shareable Link</button>
                    </div>
                </div>

                <!--  <div class="notice muted">
                    URL parameters supported: <span class="mono">iso</span>, <span class="mono">a0</span>, <span class="mono">unit</span>, <span class="mono">cal</span> (e.g., <span class="mono">?iso=F-18&a0=12000&unit=MBq&cal=2025-11-08T09:45</span>).
                    Perfect for QR codes.
                </div>  -->
            </section>




            <!-- Outputs -->
            <section class="card outputs">
                <div class="chips" id="statusChips"></div>
                <div class="column-2">
                    <div class="stat" id="activityNowBox">
                        <div class="label">Current Activity</div>
                        <div class="value" id="activityNow">‚Äî</div>
                        <div class="muted" id="activityNowAlt">‚Äî</div>
                    </div>
                    <div class="stat" id="concentrationBox">
                        <div class="label">Current Concentration</div>
                        <div class="value" id="concentrationNow">‚Äî</div>
                        <div class="muted" id="concentrationNowAlt">‚Äî</div>
                    </div>
                </div>
                <div class="row">
                    <div class="stat">
                        <div class="label">Elapsed Time</div>
                        <div class="value" id="elapsed">‚Äî</div>
                        <div class="muted" id="elapsedExact">‚Äî</div>
                    </div>
                    <div class="stat">
                        <div class="label">Decay Factor</div>
                        <div class="value" id="decayFactor">‚Äî</div>
                        <div class="muted">A = A‚ÇÄ ¬∑ e<sup>‚àíŒªt</sup>, Œª = ln(2)/T<sub>¬Ω</sub></div>
                    </div>
                </div>

                <div class="hr"></div>

                <details class="foot">
                    <summary>References</summary>
                    <ul class="ref">
                        <li>Exponential decay law and decay constant relationship explained by NIST. <a href="https://physics.nist.gov/cgi-bin/cuu/Info/half_life.html" target="_blank" rel="noopener">NIST: Half-life & decay constant</a></li>
                        <li>Half-life data (authoritative nuclear structure & decay) available via IAEA LiveChart. <a href="https://www-nds.iaea.org/relnsd/vcharthtml/VChartHTML.html" target="_blank" rel="noopener">IAEA LiveChart</a></li>
                    </ul>
                </details>
            </section>



            <!-- Plan -->
            <section class="card info" id="patientPlan">
                <h1>Patient Doses Schedule</h1>
                <div class="row">
                    <div class="field">
                        <label for="targetDose">Desired Dose</label>
                        <div style="display:flex; gap:6px;">
                            <input id="targetDose" type="number" min="0" step="0.001" placeholder="e.g., 370" inputmode="decimal" style="flex:1;">
                            <select id="doseUnit">
                                <option>mCi</option>
                                <option>MBq</option>

                            </select>
                        </div>
                        <small class="muted">Dose unit independent from vial unit.</small>

                    </div>
                    <div class="field">
                        <label>Required Volume Now</label>
                        <div class="stat">
                            <div class="value" id="requiredVolume">‚Äî</div>
                            <div class="muted" id="requiredVolumeNote">‚Äî</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="field">
                        <label for="intervalMin">Interval between patients (minutes)</label>
                        <input id="intervalMin" type="number" min="1" step="1" value="20">
                        <small class="muted">Default 20 min; editing updates times.</small>
                    </div>


                    <div class="field">
                        <label for="planStart">Plan start time (HH:MM)</label>
                        <input id="planStart" type="time">
                        <small class="muted">Default = Calibration time</small>
                    </div>


                    <div class="field">
                        <label>&nbsp;</label>
                        <div style="display:flex;gap:8px;">
                            <button class="btn" id="seedPatients">Seed from count</button>
                            <button class="btn secondary" id="addPatient">Add patient</button>
                        </div>

                    </div>
                </div>

                <div class="hr"></div>

                <div class="field">
                    <label>Patients</label>
                    <div class="stat" style="padding:0;">
                        <table style="width:100%;border-collapse:separate;border-spacing:0 8px;padding:12px;">
                            <thead>
                                <tr class="muted">
                                    <th style="text-align:center;">üîí</th>
                                    <th style="text-align:left;">Injection time (HH:MM)</th>
                                    <th style="text-align:left;">Dose (<span id="perPatientDoseUnit">mCi</span>)</th>
                                    <th style="text-align:left;">Required volume (mL)</th>
                                </tr>
                            </thead>
                            <tbody id="patientsBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="hr"></div>

                <div class="field">
                    <label>Totals</label>
                    <div class="stat">
                        <div class="value" id="totalUsedVol">Total Used: ‚Äî</div>
                        <div class="muted" id="remainingVol">Remaining: ‚Äî</div>
                    </div>
                </div>

            </section>




        </div>

    </div>



    <script>
        // ---------- Half-life dataset (minutes) ----------
        // Values chosen from widely used references; verify against IAEA LiveChart for your QA release.
        // You can add more isotopes as needed.
        const HALF_LIVES_MIN = {
            "F-18": 109.771,
            "Tc-99m": 360.0,            // 6.0 h
            "I-131": 192.5 * 60,        // ~8.02 d
            "Ga-68": 67.71,
            "Lu-177": 6.647 * 24 * 60,  // 6.647 d
            "Y-90": 64.1 * 60,          // 64.1 h
            "C-11": 20.334,
            "N-13": 9.97,
            "O-15": 2.036,
            "Zr-89": 78.41 * 60,        // 78.41 h
            "Cu-64": 12.701 * 60        // 12.701 h
        };

        const qs = new URLSearchParams(location.search);

        const el = (id) => document.getElementById(id);
        const isotope = el("isotope");
        const halfLife = el("halfLife");
        const activity0 = el("activity0");
        const unit = el("unit");
        const unitLabel = el("unitLabel");
        const calTime = el("calTime");
        const nowTime = el("nowTime");
        const recalcBtn = el("recalc");
        const shareBtn = el("shareLink");

        const statusChips = el("statusChips");
        const activityNow = el("activityNow");
        const activityNowAlt = el("activityNowAlt");
        const activityNowBox = el("activityNowBox");
        const concentrationNow = el("concentrationNow");
        const concentrationNowAlt = el("concentrationNowAlt");
        const concentrationNowBox = el("concentrationNowBox");

        const targetDose = el("targetDose");
        const doseUnitLabel = el("doseUnitLabel");
        const requiredVolume = el("requiredVolume");
        const requiredVolumeNote = el("requiredVolumeNote");


        const elapsed = el("elapsed");
        const elapsedExact = el("elapsedExact");
        const decayFactor = el("decayFactor");
        const doseUnit = el("doseUnit");

        const patientsBody = el("patientsBody");
        const intervalMinEl = el("intervalMin");
        const addPatientBtn = el("addPatient");
        const seedPatientsBtn = el("seedPatients");
        const perPatientDoseUnit = el("perPatientDoseUnit");

        // Each patient: { timeHHMM, dose, locked?: boolean, lockedMl?: string }

        let patients = [];



        const MBQ_PER_MCI = 37.0;

        // Populate isotope list
        function populateIsotopes() {
            isotope.innerHTML = "";
            const keys = Object.keys(HALF_LIVES_MIN).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            for (const key of keys) {
                const opt = document.createElement("option");
                opt.value = key; opt.textContent = key;
                isotope.appendChild(opt);
            }
            // Add a "Custom‚Ä¶" option to allow arbitrary isotopes with manual T1/2
            const custom = document.createElement("option");
            custom.value = "__custom__";
            custom.textContent = "Custom‚Ä¶";
            isotope.appendChild(custom);
        }

        function setDefaults() {
            // Default isotope
            const isoParam = qs.get("iso") || "F-18";
            if (HALF_LIVES_MIN[isoParam]) {
                isotope.value = isoParam;
                halfLife.value = HALF_LIVES_MIN[isoParam];
            } else {
                isotope.value = "__custom__";
                if (qs.has("t12min")) halfLife.value = qs.get("t12min");
            }

            if (qs.has("cust")) el("custLabel").textContent = qs.get("cust");
            if (qs.has("doses")) el("dosesLabel").textContent = qs.get("doses");
            if (qs.has("vol")) el("volLabel").textContent = qs.get("vol");
            if (qs.has("batch")) el("batchLabel").textContent = qs.get("batch");


            // --- Expiry Handling ---
            if (qs.has("exp")) {
                let expStr = qs.get("exp");
                if (expStr) expStr = decodeURIComponent(expStr).trim();
                expStr = expStr.replace("%3A", ":").replace(" ", "T");

                let expDate;

                // Force local manual parse if format is YYYY-MM-DDTHH:mm
                const match = expStr.match(/^(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})$/);
                if (match) {
                    const [_, y, mo, d, h, mi] = match.map(Number);
                    expDate = new Date(y, mo - 1, d, h, mi, 0, 0);
                } else {
                    expDate = new Date(expStr);
                }

                // üß≠ DEBUG OUTPUT
                const now = new Date();
                const diffMs = expDate - now;
                const diffMin = Math.floor(diffMs / 60000);
                const diffHr = (diffMin / 60).toFixed(2);
                console.log("üìÖ Expiry raw string:", expStr);
                console.log("üïì Parsed expDate (local):", expDate.toString());
                console.log("üïê Current time:", now.toString());
                console.log("‚è≥ Difference (ms):", diffMs);
                console.log("‚è± Difference (minutes):", diffMin);
                console.log("‚è∞ Difference (hours):", diffHr);

                if (isNaN(expDate)) {
                    console.warn("Invalid expiry date:", expStr);
                    el("expLabel").textContent = "Invalid expiry";
                    el("remainingLabel").textContent = "‚Äî";
                    return;
                }

     


                const pad = n => String(n).padStart(2, "0");
                el("expLabel").textContent =
                    `${pad(expDate.getDate())}/${pad(expDate.getMonth() + 1)}/${expDate.getFullYear()} ` +
                    `${pad(expDate.getHours())}:${pad(expDate.getMinutes())}`;

                const overlay = document.getElementById("expiredOverlay");

                function showExpiredOverlay(expDate) {
                    document.querySelector('.wrap').style.display = 'none';
                    overlay.style.display = 'flex';

                    const now = new Date();
                    const diffMin = Math.floor((now - expDate) / 60000);
                    const absMin = Math.abs(diffMin);
                    const hours = Math.floor(absMin / 60);
                    const mins = absMin % 60;

                    const timeInfo = document.createElement("p");
                    timeInfo.style.color = "var(--muted)";
                    timeInfo.style.fontSize = "1rem";
                    timeInfo.textContent = `Expired ${hours}h ${mins}m ago (${expDate.toLocaleString()})`;
                    overlay.appendChild(timeInfo);
                }

                function updateRemaining() {
                    const now = new Date();
                    const diffMs = expDate - now;
                    const diffMin = Math.floor(diffMs / 60000);
                    const absMin = Math.abs(diffMin);
                    const hours = Math.floor(absMin / 60);
                    const mins = absMin % 60;

                    // üß≠ Debug each update
                    console.log("Now:", now.toString(), "DiffMs:", diffMs);

                    if (diffMs > 0) {
                        // ‚úÖ Still valid
                        el("remainingLabel").textContent = `${hours}h ${mins}m remaining`;
                        el("remainingLabel").style.color = "var(--ok)";
                        document.querySelector('.wrap').style.display = 'block';
                        document.getElementById('expiredOverlay').style.display = 'none';
                    } else {
                        // ‚ùå Expired
                        document.querySelector('.wrap').style.display = 'none';
                        const overlay = document.getElementById('expiredOverlay');
                        overlay.style.display = 'flex';
                        overlay.querySelector("h1").textContent = "‚ö†Ô∏è This batch has expired";
                        clearInterval(expiryTimer);
                    }
                }

                updateRemaining();
                const expiryTimer = setInterval(updateRemaining, 60000);
            }
            // Helper to show overlay
            function showExpiredOverlay(expDate) {
                document.querySelector('.wrap').style.display = 'none';
                const overlay = document.getElementById('expiredOverlay');
                overlay.style.display = 'flex';

                const now = new Date();
                const diffMin = Math.floor((now - expDate) / 60000);
                const absMin = Math.abs(diffMin);
                const hours = Math.floor(absMin / 60);
                const mins = absMin % 60;

                const timeInfo = document.createElement("p");
                timeInfo.style.color = "var(--muted)";
                timeInfo.style.fontSize = "1rem";
                timeInfo.textContent = `Expired ${hours}h ${mins}m ago (${expDate.toLocaleString()})`;
                overlay.appendChild(timeInfo);
            }


            // Activity
            if (qs.has("a0")) activity0.value = qs.get("a0");
            if (qs.has("unit")) unit.value = (qs.get("unit") === "mCi") ? "mCi" : "MBq";
            if (qs.has("dose")) targetDose.value = qs.get("dose");

            unitLabel.textContent = unit.value;

            // Calibration time
            const now = new Date();
            const defaultCal = new Date(now.getTime() - 60 * 60 * 1000); // 1h ago
            const calStr = qs.get("cal") || defaultCal.toISOString().slice(0, 16);
            calTime.value = normalizeToLocal(calStr);

            // default plan start time = calibration time HH:MM
            const calObj = parseLocalDatetime(calStr);
            el("planStart").value = `${String(calObj.getHours()).padStart(2, "0")}:${String(calObj.getMinutes()).padStart(2, "0")}`;

        }

        function normalizeToLocal(v) {
            const d = (v instanceof Date) ? v : new Date(v);
            if (Number.isNaN(+d)) return "";
            const pad = (n) => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }


        function chip(text) {
            const span = document.createElement("span");
            span.className = "chip"; span.textContent = text;
            return span;
        }

        function fmt(num, digits = 3) {
            if (!isFinite(num)) return "‚Äî";
            if (num === 0) return "0";
            const abs = Math.abs(num);
            if (abs >= 1e6 || abs < 1e-3) return num.toExponential(digits);
            return num.toLocaleString(undefined, { maximumFractionDigits: digits });
        }

        function parseLocalDatetime(dtLocalValue) {
            // Treat input value (YYYY-MM-DDTHH:MM) as local time
            if (!dtLocalValue) return null;
            const [date, time] = dtLocalValue.split("T");
            if (!date || !time) return null;
            const [y, m, d] = date.split("-").map(Number);
            const [hh, mm] = time.split(":").map(Number);
            return new Date(y, (m - 1), d, hh, mm, 0, 0);
        }

        function minutesBetween(a, b) {
            // b - a in minutes
            return (b.getTime() - a.getTime()) / 60000;
        }

        function decay(a0, tMin, t12min) {
            // A = A0 * exp(-ln2 * t / T1/2)
            const ln2 = Math.log(2);
            return a0 * Math.exp(-ln2 * (tMin / t12min));
        }

        function updateUnitLabel() {
            // convert target dose value automaically
            let dose = parseFloat(targetDose.value);
            if (isFinite(dose)) {
                if (unit.value === "mCi") {
                    // convert MBq ‚Üí mCi
                    targetDose.value = (dose / MBQ_PER_MCI).toString();
                } else {
                    // convert mCi ‚Üí MBq
                    targetDose.value = (dose * MBQ_PER_MCI).toString();
                }
            }
            unitLabel.textContent = unit.value;
            doseUnitLabel.textContent = unit.value;

        }

        function currentParams() {
            const iso = isotope.value === "__custom__" ? (qs.get("iso") || "Custom") : isotope.value;
            const t12 = parseFloat(halfLife.value);
            const a0 = parseFloat(activity0.value);
            const un = unit.value;
            const cal = parseLocalDatetime(calTime.value);
            return { iso, t12, a0, un, cal };
        }

        function convertToMBq(value, fromUnit) {
            return (fromUnit === "mCi") ? value * MBQ_PER_MCI : value;
        }
        function convertFromMBq(valueMBq, toUnit) {
            return (toUnit === "mCi") ? (valueMBq / MBQ_PER_MCI) : valueMBq;
        }

        function classifyBox(isPreCalibration) {
            activityNowBox.classList.remove("ok", "warn");
            activityNowBox.classList.add(isPreCalibration ? "warn" : "ok");
        }

        function recalcOnce() {
            // Update "now" field to device time
            const now = new Date();
            nowTime.value = normalizeToLocal(now);

            const { iso, t12, a0, un, cal } = currentParams();

            statusChips.innerHTML = "";
            if (isotope.value !== "__custom__") statusChips.appendChild(chip(`Isotope: ${iso}`));
            if (isFinite(t12)) statusChips.appendChild(chip(`T¬Ω = ${fmt(t12, 3)} min`));
            if (isFinite(a0)) statusChips.appendChild(chip(`A‚ÇÄ = ${fmt(a0, 3)} ${un}`));

            if (!isFinite(t12) || t12 <= 0) {
                activityNow.textContent = "Enter a valid half-life";
                activityNowAlt.textContent = "‚Äî";
                elapsed.textContent = "‚Äî";
                elapsedExact.textContent = "‚Äî";
                decayFactor.textContent = "‚Äî";
                classifyBox(false);
                return;
            }
            if (!isFinite(a0) || a0 < 0 || !cal) {
                activityNow.textContent = "Enter valid A‚ÇÄ and calibration time";
                activityNowAlt.textContent = "‚Äî";
                elapsed.textContent = "‚Äî";
                elapsedExact.textContent = "‚Äî";
                decayFactor.textContent = "‚Äî";
                classifyBox(false);
                return;
            }

            const dtMin = minutesBetween(cal, now);
            const isPre = dtMin < 0;
            const tAbs = Math.abs(dtMin);

            const a0_MBq = convertToMBq(a0, un);
            const aNow_MBq = decay(a0_MBq, dtMin, t12);

            // Display Activity
            const aDisp = convertFromMBq(aNow_MBq, un);
            const aAlt = (un === "MBq") ? (aNow_MBq / MBQ_PER_MCI) : (aNow_MBq * MBQ_PER_MCI);
            activityNow.textContent = `${fmt(aDisp, 2)} ${un}`;
            activityNowAlt.textContent = (un === "MBq")
                ? `${fmt(aAlt, 2)} mCi`
                : `${fmt(aAlt, 2)} MBq`;

            // ---- NEW: Concentration ----
            let vol = parseFloat(qs.get("vol"));
            let concMBqperML = NaN;
            let concMCiperML = NaN;
            if (isFinite(vol) && vol > 0) {

                // always work in MBq internally
                concMBqperML = aNow_MBq / vol;
                concMCiperML = concMBqperML / MBQ_PER_MCI;


                if (un === "MBq") {
                    concentrationNow.textContent = `${fmt(concMBqperML, 1)} MBq/mL`;
                    concentrationNowAlt.textContent = `${fmt(concMCiperML, 1)} mCi/mL`;
                } else {
                    concentrationNow.textContent = `${fmt(concMCiperML, 1)} mCi/mL`;
                    concentrationNowAlt.textContent = `${fmt(concMBqperML, 1)} MBq/mL`;
                }

            } else {
                concentrationNow.textContent = "‚Äî";
                concentrationNowAlt.textContent = "‚Äî";
            }

            // ---- Dose Withdrawal (Required Volume Now) ----
            // Desired dose can be in independent unit (MBq or mCi)
            const desiredDose = parseFloat(targetDose.value);

            if (isFinite(desiredDose) && desiredDose > 0 && isFinite(vol) && vol > 0) {

                // convert desired dose to MBq always internal reference
                let doseMBq = (doseUnit.value === "mCi")
                    ? desiredDose * MBQ_PER_MCI
                    : desiredDose;

                // concentration always MBq/mL internal
                if (isFinite(concMBqperML) && concMBqperML > 0) {
                    const mlNeeded = doseMBq / concMBqperML; // mL required NOW
                    requiredVolume.textContent = `${fmt(mlNeeded, 1)} mL`;
                    requiredVolumeNote.textContent = `Based on ${fmt(concMBqperML, 1)} MBq/mL`;
                } else {
                    requiredVolume.textContent = "‚Äî";
                    requiredVolumeNote.textContent = "Set volume (vol) to enable concentration.";
                }

            } else {
                requiredVolume.textContent = "‚Äî";
                requiredVolumeNote.textContent = "Enter desired dose to calculate withdrawal volume.";
            }


            // --- Patient rows live calc ---
            (() => {
                const volURL = parseFloat(qs.get("vol"));
                const canCalc = isFinite(volURL) && volURL > 0;



                // Skip if no patient rows
                if (!patients.length) return;

                const calLocal = parseLocalDatetime(calTime.value);

                patients.forEach((p, i) => {
                    const cell = document.getElementById(`volCell-${i}`);
                    if (!cell) return;

                    if (patients[i]?.locked) {
                        freezeRowIfLocked(i);
                        return;
                    }
                    if (!canCalc) {
                        cell.textContent = "‚Äî";
                        return;
                    }

                    // activity at the *patient injection time*
                    const injDate = dateWithHHMM(calLocal, p.timeHHMM);
                    const dtMinPatient = minutesBetween(calLocal, injDate); // signed
                    const aAtInj_MBq = decay(a0_MBq, dtMinPatient, t12);    // MBq in vial at inj time

                    const concAtInj_MBq_per_mL = aAtInj_MBq / volURL;       // MBq/mL at inj time

                    // convert patient‚Äôs entered dose to MBq using the per-patient dose unit selector
                    const doseEntered = parseFloat(p.dose);
                    if (!isFinite(doseEntered) || doseEntered <= 0 || !isFinite(concAtInj_MBq_per_mL) || concAtInj_MBq_per_mL <= 0) {
                        cell.textContent = "‚Äî";
                        return;
                    }

                    const doseMBq = (doseUnit.value === "mCi") ? doseEntered * MBQ_PER_MCI : doseEntered;
                    const mlNeeded = doseMBq / concAtInj_MBq_per_mL;

                    cell.textContent = fmt(mlNeeded, 1) + " mL";
                });
                // ensure locked rows keep frozen values
                patients.forEach((_, i) => freezeRowIfLocked(i));

            })();

            // --- Total volume / Remaining summary ---
            (() => {
                const volURL = parseFloat(qs.get("vol"));
                if (!patients.length || !isFinite(volURL) || volURL <= 0) {
                    el("totalUsedVol").textContent = "Total Used: ‚Äî";
                    el("remainingVol").textContent = "Remaining: ‚Äî";
                    return;
                }

                let sum = 0;
                patients.forEach((p, i) => {
                    const cell = document.getElementById(`volCell-${i}`);
                    if (!cell) return;
                    const v = parseFloat(cell.textContent);
                    if (isFinite(v)) sum += v;
                });

                const remaining = volURL - sum;

                el("totalUsedVol").textContent = `Total Used: ${fmt(sum, 1)} mL`;
                el("remainingVol").textContent = `Remaining: ${fmt(remaining, 1)} mL`;
            })();

            // Elapsed Time display
            const days = Math.floor(tAbs / (60 * 24));
            const hours = Math.floor((tAbs - days * 60 * 24) / 60);
            const mins = Math.floor(tAbs - days * 60 * 24 - hours * 60);

            const signWord = isPre ? "until calibration" : "since calibration";
            const parts = [];
            if (days) parts.push(`${days} d`);
            if (hours) parts.push(`${hours} h`);
            parts.push(`${mins} min`);
            elapsed.textContent = `${parts.join(" ")} ${signWord}`;
            elapsedExact.textContent = `${fmt(dtMin, 1)} minutes (signed)`;

            const lambda = Math.log(2) / t12;
            const factor = Math.exp(-lambda * dtMin);
            decayFactor.textContent = `√ó ${fmt(factor, 4)}`;

            classifyBox(isPre);
        }

        function toLocalISOWithOffset(date) {
            const tzo = -date.getTimezoneOffset();
            const dif = tzo >= 0 ? "+" : "-";
            const pad = (num) => String(Math.floor(Math.abs(num))).padStart(2, "0");
            return date.getFullYear() +
                "-" + pad(date.getMonth() + 1) +
                "-" + pad(date.getDate()) +
                "T" + pad(date.getHours()) +
                ":" + pad(date.getMinutes()) +
                ":" + pad(date.getSeconds()) +
                dif + pad(tzo / 60) +
                ":" + pad(tzo % 60);
        }


        function pad2(n) { return String(n).padStart(2, "0"); }

        function addMinutes(date, mins) {
            return new Date(date.getFullYear(), date.getMonth(), date.getDate(),
                date.getHours(), date.getMinutes() + mins, 0, 0);
        }

        function dateWithHHMM(baseDate, hhmm) {
            const [h, m] = hhmm.split(":").map(v => parseInt(v, 10));
            return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h || 0, m || 0, 0, 0);
        }

        function hhmmFromDate(d) {
            return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        }

        function respaceRespectingLocks() {
            // Re-space ONLY unlocked rows; keep locked rows fixed in time.
            const start = planStartDate();
            const step = parseInt(intervalMinEl.value, 10) || 20;

            // Cursor starts at plan start. As we walk in index order:
            // - If row is locked: move cursor to (lockedTime + step)
            // - If row is unlocked: set its time to cursor, advance cursor by step
            let cursor = new Date(start.getTime());

            for (let i = 0; i < patients.length; i++) {
                const p = patients[i];
                if (p.locked) {
                    // honor the locked time and advance the cursor after it
                    const lockedDate = dateWithHHMM(start, p.timeHHMM);
                    cursor = addMinutes(lockedDate, step);
                } else {
                    p.timeHHMM = hhmmFromDate(cursor);
                    cursor = addMinutes(cursor, step);
                }
            }
        }

        function freezeRowIfLocked(i) {
            // If row i is locked, keep its displayed ML exactly as stored
            const p = patients[i];
            const cell = document.getElementById(`volCell-${i}`);
            if (!p || !cell) return;
            if (p.locked) {
                // Show frozen value if we have it; otherwise keep current text
                cell.textContent = (typeof p.lockedMl === "string" && p.lockedMl.length)
                    ? p.lockedMl
                    : cell.textContent;
            }
        }


        function planStartDate() {
            const cal = parseLocalDatetime(calTime.value);
            const ps = el("planStart").value;
            if (!ps) return cal;
            return dateWithHHMM(cal, ps);
        }


        function renderPatients() {
            perPatientDoseUnit.textContent = doseUnit.value;

            patientsBody.innerHTML = "";
            patients.forEach((p, i) => {
                const locked = !!p.locked;
                const tr = document.createElement("tr");

                tr.innerHTML = `
          <td style="white-space:nowrap;">
            ${i + 1}
            <button class="btn secondary" data-action="toggle-lock" data-idx="${i}" style="margin-left:8px;padding:4px 8px;">
              ${locked ? "üîí" : "üîì"}
            </button>
          </td>
          <td>
            <input type="time" value="${p.timeHHMM}" data-idx="${i}" data-field="time" ${locked ? "disabled" : ""}/>
          </td>
          <td>
            <input type="number" min="0" step="0.001"
                   value="${isFinite(p.dose) ? p.dose : ""}"
                   data-idx="${i}" data-field="dose" style="max-width:140px;" ${locked ? "disabled" : ""}/>
            <span class="muted">${doseUnit.value}</span>
          </td>
          <td>
            <span id="volCell-${i}">‚Äî</span>
            ${locked ? `<span class="chip" style="margin-left:8px;">Locked</span>` : ""}
          </td>
        `;
                patientsBody.appendChild(tr);
            });
        }


        function seedFromCount() {
            const countFromUrl = parseInt(qs.get("doses"), 10);
            const n = Number.isInteger(countFromUrl) && countFromUrl > 0 ? countFromUrl : 1;
            const defaultDose = parseFloat(targetDose.value) || 0;

            // Keep all locked rows; drop all unlocked rows, then refill unlocked until length >= n
            const lockedRows = patients.filter(p => p.locked);
            patients = [...lockedRows];

            while (patients.length < n) {
                patients.push({ timeHHMM: hhmmFromDate(planStartDate()), dose: defaultDose, locked: false, lockedMl: "" });
            }
            // If patients.length > n because too many locked rows, we keep them (never delete locked).

            respaceRespectingLocks();
            renderPatients();
        }


        function attachHandlers() {
            isotope.addEventListener("change", () => {
                if (isotope.value === "__custom__") {
                    // keep user-entered half-life
                } else {
                    halfLife.value = HALF_LIVES_MIN[isotope.value];
                }
                recalcOnce();
            });
            halfLife.addEventListener("input", recalcOnce);
            activity0.addEventListener("input", recalcOnce);
            unit.addEventListener("change", () => { updateUnitLabel(); recalcOnce(); });
            calTime.addEventListener("change", recalcOnce);
            recalcBtn.addEventListener("click", recalcOnce);
            targetDose.addEventListener("input", recalcOnce);
            unit.addEventListener("change", () => { updateUnitLabel(); recalcOnce(); });

            doseUnit.addEventListener("change", recalcOnce);

            intervalMinEl.addEventListener("input", () => {
                if (!patients.length) return;
                respaceRespectingLocks();
                renderPatients();
                recalcOnce();

            });

            addPatientBtn.addEventListener("click", () => {
                const defaultDose = parseFloat(targetDose.value) || 0;
                patients.push({ timeHHMM: hhmmFromDate(planStartDate()), dose: defaultDose, locked: false, lockedMl: "" });
                respaceRespectingLocks();
                renderPatients();
                recalcOnce();
            });

            seedPatientsBtn.addEventListener("click", () => {
                seedFromCount();
                recalcOnce();
            });

            el("planStart").addEventListener("change", () => {
                if (!patients.length) return;
                respaceRespectingLocks();
                renderPatients();
                recalcOnce();

            });

            // delegate edits from table
            // Block edits to locked rows (already disabled, but guard anyway)
            patientsBody.addEventListener("input", (e) => {
                const t = e.target;
                const idx = parseInt(t.getAttribute("data-idx"), 10);
                const field = t.getAttribute("data-field");
                if (!Number.isInteger(idx) || !field) return;
                if (patients[idx]?.locked) return; // ignore edits for locked rows

                if (field === "time") {
                    patients[idx].timeHHMM = t.value;
                }
                if (field === "dose") {
                    patients[idx].dose = parseFloat(t.value) || 0;
                }

                recalcOnce();
            });


            // Handle lock/unlock button
            patientsBody.addEventListener("click", (e) => {
                const btn = e.target.closest('button[data-action="toggle-lock"]');
                if (!btn) return;
                const idx = parseInt(btn.getAttribute("data-idx"), 10);
                if (!Number.isInteger(idx) || !patients[idx]) return;

                const p = patients[idx];
                const cell = document.getElementById(`volCell-${idx}`);

                if (!p.locked) {
                    // Going to LOCK: snapshot current displayed mL (if any)
                    p.locked = true;
                    p.lockedMl = cell ? cell.textContent : "";
                } else {
                    // Going to UNLOCK: allow recomputation
                    p.locked = false;
                    p.lockedMl = "";
                }

                renderPatients();   // updates button label + disables inputs
                recalcOnce();       // recompute; freezeRowIfLocked will pin mL
            });


            targetDose.addEventListener("input", () => {
                // new rows added later will use this default; existing rows stay as edited
                recalcOnce();
            });
            doseUnit.addEventListener("change", () => {
                perPatientDoseUnit.textContent = doseUnit.value;
            });


            // keep header dose unit in sync with the selector you already added
            doseUnit.addEventListener("change", () => {
                renderPatients();
                recalcOnce();
            });


            shareBtn.addEventListener("click", async () => {
                const { iso, t12, a0, un, cal } = currentParams();
                const params = new URLSearchParams();

                // Core decay parameters
                params.set("iso", iso);
                if (isotope.value === "__custom__" && isFinite(t12)) {
                    params.set("t12min", String(t12));
                }

                if (isFinite(a0)) params.set("a0", String(a0));
                params.set("unit", un);

                // Calibration date (ISO 8601 local time with offset)
                if (cal) params.set("cal", toLocalISOWithOffset(cal));

                // --- Shipment / batch metadata ---
                if (qs.has("cust")) params.set("cust", qs.get("cust"));
                if (qs.has("doses")) params.set("doses", qs.get("doses"));
                if (qs.has("vol")) params.set("vol", qs.get("vol"));
                if (qs.has("batch")) params.set("batch", qs.get("batch"));
                if (qs.has("exp")) params.set("exp", qs.get("exp")); // expiry from QR
                if (targetDose.value && isFinite(parseFloat(targetDose.value))) {
                    params.set("dose", targetDose.value);
                }

                // --- Build final link ---
                const url = `${location.origin}${location.pathname}?${params.toString()}`;

                // --- Copy link to clipboard or show fallback ---
                try {
                    await navigator.clipboard.writeText(url);
                    shareBtn.textContent = "Link Copied ‚úì";
                    setTimeout(() => (shareBtn.textContent = "Copy Shareable Link"), 1400);
                } catch {
                    prompt("Copy this link:", url);
                }
            });



            // Live update every 1s
            setInterval(recalcOnce, 1000);
        }

        // Boot
        populateIsotopes();
        setDefaults();
        // After setDefaults();
        seedFromCount();
        renderPatients();

        attachHandlers();
        recalcOnce();
    </script>
</body>
</html>
